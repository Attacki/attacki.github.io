---
title: Snabbdom 虚拟dom
tag: vue
---
# SnabbdomJS
Vuejs就是借鉴这个项目来构建虚拟dom的，希望可以对typescript和vnode更加熟悉，为探索Vuejs源码做铺垫。   

这里涉及到的内容大部分都是虚拟的，是在js中的，模拟真实dom中，我们常用到的内容，比如class，元素属性（如video的muted属性等）、自定义属性（data-*），事件监听器（负责函数回调与事件更新），

## 处理节点属性
对新旧节点属性进行遍历更新和添加。
```ts
// 更新新旧节点属性
function updateAttrs(oldVnode: VNode, vnode: VNode): void {
  var key: string, elm: Element = vnode.elm as Element,
      oldAttrs = (oldVnode.data as VNodeData).attrs,
      attrs = (vnode.data as VNodeData).attrs;

  if (!oldAttrs && !attrs) return;
  if (oldAttrs === attrs) return;
  oldAttrs = oldAttrs || {};
  attrs = attrs || {};

  // 更新修改的属性， 添加新属性
  for (key in attrs) {
    const cur = attrs[key];
    const old = oldAttrs[key];
    if (old !== cur) {
      if (cur === true) {
        elm.setAttribute(key, "");  // 如果为true就是直接添加上去
      } else if (cur === false) {
        elm.removeAttribute(key);   // 如果为false就是直接删除
      } else {
        elm.setAttribute(key, cur);
      }
    }
  }

  for (key in oldAttrs) {
    if (!(key in attrs)) {
      elm.removeAttribute(key);
    }
  }
}
```

## 处理节点class属性
```ts
type Classes = Record<string, boolean> //键是string，值是布尔, true表示这个class存在，false表示不存在
// 更新class
function updateClass(oldVnode: VNode, vnode: VNode): void {
  var cur: any, name: string, elm: Element = vnode.elm as Element,
      oldClass = (oldVnode.data as VNodeData).class,
      klass = (vnode.data as VNodeData).class;

  if (!oldClass && !klass) return;
  if (oldClass === klass) return;
  oldClass = oldClass || {};
  klass = klass || {};

  for (name in oldClass) {
    if (!klass[name]) {
      elm.classList.remove(name);
    }
  }
  for (name in klass) {
    cur = klass[name];
    if (cur !== oldClass[name]) {
      (elm.classList as any)[cur ? 'add' : 'remove'](name);
    }
  }
}

const classModule = {create: updateClass, update: updateClass} as Module
```

## 处理data-类属性
```ts
type Dataset = Record<string, string>;
const CAPS_REGEX = /[A-Z]/g; // 处理驼峰式属性

function updateDataset(oldVnode: VNode, vnode: VNode): void {
  let elm: HTMLElement = vnode.elm as HTMLElement,
    oldDataset = (oldVnode.data as VNodeData).dataset,
    dataset = (vnode.data as VNodeData).dataset,
    key: string;

  if (!oldDataset && !dataset) return;
  if (oldDataset === dataset) return;
  oldDataset = oldDataset || {};
  dataset = dataset || {};
  const d = elm.dataset; // 指定的HTML元素

  for (key in oldDataset) { //遍历旧节点属性
    if (!dataset[key]) {
      if (d) {
        if (key in d) { // 新节点没有该属性，就在HTML元素上删除
          delete d[key];
        }
      } else {
        elm.removeAttribute('data-' + key.replace(CAPS_REGEX, '-$&').toLowerCase()); // 处理驼峰式属性
      }
    }
  }
  for (key in dataset) {  //遍历新节点属性
    if (oldDataset[key] !== dataset[key]) {
      if (d) {
        d[key] = dataset[key];  //更新为新节点的属性值
      } else {
        elm.setAttribute('data-' + key.replace(CAPS_REGEX, '-$&').toLowerCase(), dataset[key]); //元素还没设置过data-类属性，就添加一个咯
      }
    }
  }
}
```


##  节点概念描述 Vnode VNodeData Hooks
VNode 包含有选择符，数据，子节点，其他节点，文本，key键

```ts
type Key = string | number;

interface VNode {
  sel: string | undefined;  
  data: VNodeData | undefined;
  children: Array<VNode | string> | undefined;
  elm: Node | undefined;
  text: string | undefined;
  key: Key | undefined;
}

interface VNodeData {
  props?: Props;        // 传递属性
  attrs?: Attrs;        // 节点属性 例如 video的muted
  class?: Classes;      // 类名列表
  style?: VNodeStyle;   // 样式属性
  dataset?: Dataset;    // 设置在节点上的 data-* 类的属性
  on?: On;
  hero?: Hero;
  attachData?: AttachData;
  hook?: Hooks;
  key?: Key;
  ns?: string; // for SVGs
  fn?: () => VNode; // for thunks
  args?: Array<any>; // for thunks
  [key: string]: any; // for any other 3rd party module
}

type VNodeStyle = Record<string, string> & {
  delayed?: Record<string, string>
  remove?: Record<string, string>
}


type PreHook = () => any;    // 初始化之前
type InitHook = (vNode: VNode) => any;   // 初始化的时候
type CreateHook = (emptyVNode: VNode, vNode: VNode) => any;  // 创建实例
type InsertHook = (vNode: VNode) => any; // 插入dom
type PrePatchHook = (oldVNode: VNode, vNode: VNode) => any;  // 制作补丁的时候
type UpdateHook = (oldVNode: VNode, vNode: VNode) => any;    // 更新的时候
type PostPatchHook = (oldVNode: VNode, vNode: VNode) => any; // 打上补丁的之后
type DestroyHook = (vNode: VNode) => any;    // 销毁实例
type RemoveHook = (vNode: VNode, removeCallback: () => void) => any; // 移除
type PostHook = () => any;   // 

interface Hooks {
  pre?: PreHook;
  init?: InitHook;
  create?: CreateHook;
  insert?: InsertHook;
  prepatch?: PrePatchHook;
  update?: UpdateHook;
  postpatch?: PostPatchHook;
  destroy?: DestroyHook;
  remove?: RemoveHook;
  post?: PostHook;
}
```


### 工具函数

```ts
// 根据标签名生成 Element元素
function createElement(tagName: any): HTMLElement {
  return document.createElement(tagName);
}
// 创建一个具有指定的命名空间URI和限定名称的元素。 
// 例如：newdiv = document.createElementNS("http://www.w3.org/1999/xhtml","div");
function createElementNS(namespaceURI: string, qualifiedName: string): Element {
  return document.createElementNS(namespaceURI, qualifiedName);
}
// 创建文本节点
function createTextNode(text: string): Text {
  return document.createTextNode(text);
}
// 创建注释节点
function createComment(text: string): Comment {
  return document.createComment(text);
}
// 将 newNode 插入 referenceNode 的前面 （它俩都是）
function insertBefore(parentNode: Node, newNode: Node, referenceNode: Node | null): void {
  parentNode.insertBefore(newNode, referenceNode);
}

function removeChild(node: Node, child: Node): void {
  node.removeChild(child);
}

function appendChild(node: Node, child: Node): void {
  node.appendChild(child);
}

function parentNode(node: Node): Node | null {
  return node.parentNode;
}

function nextSibling(node: Node): Node | null {
  return node.nextSibling;
}

function tagName(elm: Element): string {
  return elm.tagName;
}

function setTextContent(node: Node, text: string | null): void {
  node.textContent = text;
}

function getTextContent(node: Node): string | null {
  return node.textContent;
}

function isElement(node: Node): node is Element {
  return node.nodeType === 1;
}

function isText(node: Node): node is Text {
  return node.nodeType === 3;
}

function isComment(node: Node): node is Comment {
  return node.nodeType === 8;
}

const htmlDomApi = {
  createElement,
  createElementNS,
  createTextNode,
  createComment,
  insertBefore,
  removeChild,
  appendChild,
  parentNode,
  nextSibling,
  tagName,
  setTextContent,
  getTextContent,
  isElement,
  isText,
  isComment,
} as DOMAPI;

```