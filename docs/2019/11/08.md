---
title: 'Snabbdom 虚拟dom'
---
# SnabbdomJS
Vuejs就是借鉴这个项目来构建虚拟dom的，希望可以对typescript和vnode更加熟悉，为探索Vuejs源码做铺垫。

##  节点概念描述 Vnode VNodeData Hooks
VNode 包含有选择符，数据，子节点，其他节点，文本，key键

```ts
export type Key = string | number;

export interface VNode {
  sel: string | undefined;  
  data: VNodeData | undefined;
  children: Array<VNode | string> | undefined;
  elm: Node | undefined;
  text: string | undefined;
  key: Key | undefined;
}

export interface VNodeData {
  props?: Props;        // 传递属性
  attrs?: Attrs;        // 节点属性 例如 video的muted
  class?: Classes;      // 类名列表
  style?: VNodeStyle;   // 样式属性
  dataset?: Dataset;    // 设置在节点上的 data-* 类的属性
  on?: On;
  hero?: Hero;
  attachData?: AttachData;
  hook?: Hooks;
  key?: Key;
  ns?: string; // for SVGs
  fn?: () => VNode; // for thunks
  args?: Array<any>; // for thunks
  [key: string]: any; // for any other 3rd party module
}

type VNodeStyle = Record<string, string> & {
  delayed?: Record<string, string>
  remove?: Record<string, string>
}

/* typescript中的中高级类型 Record

Record的源码：
type Record<K extends keyof any, T> = {
    [P in K]: T;
};

例子：
type petsGroup = 'dog' | 'cat' | 'fish';
interface IPetInfo {
    name:string,
    age:number,
}
type IPets = Record<petsGroup, IPetInfo>;
const animalsInfo:IPets = {
    dog:{
        name:'dogName',
        age:2
    },
    cat:{
        name:'catName',
        age:3
    },
    fish:{
        name:'fishName',
        age:5
    }
}
// 可以看到 IPets 类型是由 Record<petsGroup, IPetInfo>返回的。
// 将petsGroup中的每个值('dog' | 'cat' | 'fish')都转为 IPetInfo 类型。
*/

export type PreHook = () => any;    // 初始化之前
export type InitHook = (vNode: VNode) => any;   // 初始化的时候
export type CreateHook = (emptyVNode: VNode, vNode: VNode) => any;  // 创建实例
export type InsertHook = (vNode: VNode) => any; // 插入dom
export type PrePatchHook = (oldVNode: VNode, vNode: VNode) => any;  // 制作补丁的时候
export type UpdateHook = (oldVNode: VNode, vNode: VNode) => any;    // 更新的时候
export type PostPatchHook = (oldVNode: VNode, vNode: VNode) => any; // 打上补丁的之后
export type DestroyHook = (vNode: VNode) => any;    // 销毁实例
export type RemoveHook = (vNode: VNode, removeCallback: () => void) => any; // 移除
export type PostHook = () => any;   // 

export interface Hooks {
  pre?: PreHook;
  init?: InitHook;
  create?: CreateHook;
  insert?: InsertHook;
  prepatch?: PrePatchHook;
  update?: UpdateHook;
  postpatch?: PostPatchHook;
  destroy?: DestroyHook;
  remove?: RemoveHook;
  post?: PostHook;
}
```


### 工具函数

```ts
// 根据标签名生成 Element元素
function createElement(tagName: any): HTMLElement {
  return document.createElement(tagName);
}
// 创建一个具有指定的命名空间URI和限定名称的元素。 
// 例如：newdiv = document.createElementNS("http://www.w3.org/1999/xhtml","div");
function createElementNS(namespaceURI: string, qualifiedName: string): Element {
  return document.createElementNS(namespaceURI, qualifiedName);
}
// 创建文本节点
function createTextNode(text: string): Text {
  return document.createTextNode(text);
}
// 创建注释节点
function createComment(text: string): Comment {
  return document.createComment(text);
}
// 将 newNode 插入 referenceNode 的前面 （它俩都是）
function insertBefore(parentNode: Node, newNode: Node, referenceNode: Node | null): void {
  parentNode.insertBefore(newNode, referenceNode);
}

function removeChild(node: Node, child: Node): void {
  node.removeChild(child);
}

function appendChild(node: Node, child: Node): void {
  node.appendChild(child);
}

function parentNode(node: Node): Node | null {
  return node.parentNode;
}

function nextSibling(node: Node): Node | null {
  return node.nextSibling;
}

function tagName(elm: Element): string {
  return elm.tagName;
}

function setTextContent(node: Node, text: string | null): void {
  node.textContent = text;
}

function getTextContent(node: Node): string | null {
  return node.textContent;
}

function isElement(node: Node): node is Element {
  return node.nodeType === 1;
}

function isText(node: Node): node is Text {
  return node.nodeType === 3;
}

function isComment(node: Node): node is Comment {
  return node.nodeType === 8;
}

export const htmlDomApi = {
  createElement,
  createElementNS,
  createTextNode,
  createComment,
  insertBefore,
  removeChild,
  appendChild,
  parentNode,
  nextSibling,
  tagName,
  setTextContent,
  getTextContent,
  isElement,
  isText,
  isComment,
} as DOMAPI;

export default htmlDomApi;

```